services:
  # Servicio de la aplicaciÃ³n Astro (sin MongoDB local)
  app:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - PUBLIC_CLERK_PUBLISHABLE_KEY=${PUBLIC_CLERK_PUBLISHABLE_KEY}
        - CLERK_SECRET_KEY=${CLERK_SECRET_KEY}
    container_name: profuso-app
    restart: unless-stopped
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - HOST=${HOST:-0.0.0.0}
      - PORT=${PORT:-4321}
      - MONGODB_URI=${MONGODB_URI}
      - MONGODB_DB_NAME=${MONGODB_DB_NAME:-profuso}
      - CLERK_SECRET_KEY=${CLERK_SECRET_KEY}
      - PUBLIC_CLERK_PUBLISHABLE_KEY=${PUBLIC_CLERK_PUBLISHABLE_KEY}
      - CLERK_ALLOWED_ORG_ID=${CLERK_ALLOWED_ORG_ID}
      - CLERK_ALLOWED_ROLE=${CLERK_ALLOWED_ROLE}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASS=${SMTP_PASS}
      - ADMIN_EMAIL=${ADMIN_EMAIL}
      - MAINTENANCE_MODE=${MAINTENANCE_MODE:-false}
      - PUBLIC_SITE_URL=${PUBLIC_SITE_URL}
    ports:
      - "${PORT:-4321}:4321"
    volumes:
      # Persistir uploads fuera del contenedor
      - ./public/uploads:/app/dist/client/uploads
    networks:
      - profuso-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:4321/', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  profuso-network:
    driver: bridge
